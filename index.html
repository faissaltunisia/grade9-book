<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>منصة تِقني الذكية | المنهج العماني</title>
    
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Tajawal:wght@400;700;900&display=swap" rel="stylesheet">
    
    <script src="https://cdnjs.cloudflare.com/ajax/libs/brython/3.11.0/brython.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/brython/3.11.0/brython_stdlib.min.js"></script>

    <style>
        :root { --primary: #4f46e5; --success: #10b981; --warning: #f59e0b; --danger: #ef4444; --dark: #0f172a; }
        * { box-sizing: border-box; font-family: 'Tajawal', sans-serif; -webkit-tap-highlight-color: transparent; }
        body, html { margin: 0; padding: 0; height: 100%; width: 100%; background: #f1f5f9; overflow: hidden; display: flex; flex-direction: column; }

        /* شريط المساعد المراقب (العين الذكية) */
        .ai-monitor {
            height: 60px; background: white; border-bottom: 1px solid #e2e8f0;
            display: flex; align-items: center; padding: 0 15px; gap: 12px; flex-shrink: 0;
            border-right: 5px solid var(--primary); transition: 0.3s;
        }
        .ai-status-icon { width: 12px; height: 12px; border-radius: 50%; background: var(--primary); box-shadow: 0 0 10px var(--primary); animation: pulse 2s infinite; }
        .ai-guidance-text { font-size: 0.85rem; font-weight: bold; color: #334155; flex: 1; overflow: hidden; white-space: nowrap; text-overflow: ellipsis; }

        /* الحاوية المتجاوبة للمحرر والنتائج */
        .workspace { flex: 1; display: flex; flex-direction: column; overflow: hidden; }

        .editor-box { flex: 1.2; background: #1e293b; position: relative; }
        #editor { width: 100%; height: 100%; background: transparent; color: #a5f3fc; padding: 15px; font-family: 'Consolas', monospace; font-size: 1.05rem; border: none; outline: none; resize: none; line-height: 1.5; }

        .output-box { flex: 0.8; background: #000; border-top: 2px solid #334155; display: flex; flex-direction: column; }
        .output-header { background: #111; color: #666; font-size: 0.7rem; padding: 5px 15px; font-weight: bold; text-transform: uppercase; }
        #console { flex: 1; padding: 10px 15px; color: var(--success); font-family: monospace; overflow-y: auto; font-size: 0.9rem; white-space: pre-wrap; }

        /* شريط التحكم السفلي */
        .nav-bar { height: 75px; background: white; border-top: 1px solid #e2e8f0; display: flex; align-items: center; padding: 0 10px; gap: 8px; flex-shrink: 0; }
        .btn-action { flex: 1; height: 50px; border-radius: 14px; border: none; font-weight: 900; display: flex; align-items: center; justify-content: center; gap: 6px; font-size: 0.9rem; }
        .btn-run { background: var(--success); color: white; flex: 2.2; box-shadow: 0 4px 12px rgba(16, 185, 129, 0.3); }
        .btn-chat { background: var(--primary); color: white; box-shadow: 0 4px 12px rgba(79, 70, 229, 0.3); }
        .btn-clear { background: #f1f5f9; color: #64748b; }

        /* نافذة الدردشة المستعدة للإجابة */
        #chat-overlay { position: fixed; inset: 0; background: white; z-index: 2000; display: none; flex-direction: column; animation: slideUp 0.3s ease; }
        .chat-header { padding: 15px; background: var(--primary); color: white; display: flex; justify-content: space-between; align-items: center; }
        .chat-messages { flex: 1; padding: 15px; overflow-y: auto; background: #f8fafc; display: flex; flex-direction: column; gap: 12px; }
        .bubble { padding: 12px 16px; border-radius: 18px; max-width: 85%; font-size: 0.95rem; line-height: 1.5; box-shadow: 0 2px 4px rgba(0,0,0,0.05); }
        .ai-bubble { background: white; color: #1e293b; align-self: flex-start; border-bottom-right-radius: 4px; }
        .user-bubble { background: var(--primary); color: white; align-self: flex-end; border-bottom-left-radius: 4px; }
        .chat-input-area { padding: 15px; border-top: 1px solid #e2e8f0; display: flex; gap: 10px; background: white; }
        #chat-input { flex: 1; padding: 12px; border-radius: 12px; border: 1px solid #ddd; outline: none; }

        @keyframes pulse { 0% { opacity: 1; transform: scale(1); } 50% { opacity: 0.5; transform: scale(1.2); } 100% { opacity: 1; transform: scale(1); } }
        @keyframes slideUp { from { transform: translateY(100%); } to { transform: translateY(0); } }
    </style>
</head>
<body onload="brython()">

    <div class="ai-monitor" id="ai-monitor">
        <div class="ai-status-icon" id="status-icon"></div>
        <div class="ai-guidance-text" id="guidance-text">تِقني يراقب كودك.. ابدأ الكتابة وسأرشدك!</div>
        <div style="font-size: 0.7rem; color: var(--primary); font-weight: bold;"><i class="fas fa-shield-halved"></i> نشط</div>
    </div>

    <div class="workspace">
        <div class="editor-box">
            <textarea id="editor" spellcheck="false" oninput="liveMonitor()"># اكتب كود بايثون هنا
print("مرحباً بك يا مبرمج المستقبل")</textarea>
        </div>

        <div class="output-box">
            <div class="output-header">نتائج التنفيذ</div>
            <div id="console">>>> جاهز لتشغيل البرنامج...</div>
        </div>
    </div>

    <nav class="nav-bar">
        <button class="btn-action btn-clear" onclick="clearAll()"><i class="fas fa-trash-can"></i></button>
        <button class="btn-action btn-run" onclick="runPython()">
            <i class="fas fa-play"></i> ▶ تشغيل البرنامج
        </button>
        <button class="btn-action btn-chat" onclick="openChat()">
            <i class="fas fa-comment-dots"></i> اسأل تِقني
        </button>
    </nav>

    <div id="chat-overlay">
        <div class="chat-header">
            <strong><i class="fas fa-robot"></i> دردشة مع تِقني</strong>
            <i class="fas fa-times" onclick="closeChat()" style="font-size: 1.5rem; cursor: pointer;"></i>
        </div>
        <div class="chat-messages" id="chat-box">
            <div class="bubble ai-bubble">أهلاً بك! أنا مساعدك الذكي. يمكنني شرح الكود لك أو الإجابة على أي سؤال حول مادة تقنية المعلومات. ماذا يدور في ذهنك؟</div>
        </div>
        <div class="chat-input-area">
            <input type="text" id="chat-input" placeholder="اكتب سؤالك هنا..." onkeypress="if(event.key==='Enter') sendChat()">
            <button onclick="sendChat()" style="background:var(--primary); color:white; border:none; width:45px; border-radius:12px;"><i class="fas fa-paper-plane"></i></button>
        </div>
    </div>

    <script type="text/python">
        from browser import document, window
        def execute_code(ev=None):
            document["console"].text = ""
            def log(*args): document["console"].text += " ".join(map(str, args)) + "\n"
            try:
                exec(document["editor"].value, {"print": log, "input": window.prompt})
                window.updateMonitor("success")
            except Exception as e:
                document["console"].text = f"❌ خطأ برمي:\n{str(e)}"
                window.updateMonitor("error", str(e))
        window.pyRun = execute_code
    </script>

    <script>
        // 1. المساعد المراقب (التوجيه التلقائي اللحظي)
        function liveMonitor() {
            const code = document.getElementById('editor').value;
            const text = document.getElementById('guidance-text');
            const icon = document.getElementById('status-icon');
            const bar = document.getElementById('ai-monitor');

            if (code.includes('print') && !code.includes('(')) {
                text.innerText = "تِقني: انتبه! دالة print تحتاج إلى أقواس () لتعمل.";
                icon.style.background = "var(--danger)";
                bar.style.borderColor = "var(--danger)";
            } else if (code.includes('if') && !code.includes(':')) {
                text.innerText = "تِقني: تذكر وضع النقطتين (:) في نهاية جملة if.";
                icon.style.background = "var(--warning)";
                bar.style.borderColor = "var(--warning)";
            } else {
                text.innerText = "تِقني يتابع كودك.. أنت تبلي بلاءً حسناً!";
                icon.style.background = "var(--primary)";
                bar.style.borderColor = "var(--primary)";
            }
        }

        function updateMonitor(status, errorMsg = "") {
            const text = document.getElementById('guidance-text');
            const icon = document.getElementById('status-icon');
            if(status === "success") {
                text.innerText = "تِقني: رائع! الكود يعمل بشكل صحيح 100%.";
                icon.style.background = "var(--success)";
            } else {
                text.innerText = "تِقني: اكتشفت خطأ في التشغيل، حاول إصلاحه!";
                icon.style.background = "var(--danger)";
            }
        }

        // 2. المساعد المحاور (نظام الدردشة الذكي)
        function openChat() { document.getElementById('chat-overlay').style.display = 'flex'; }
        function closeChat() { document.getElementById('chat-overlay').style.display = 'none'; }

        async function sendChat() {
            const input = document.getElementById('chat-input');
            const box = document.getElementById('chat-box');
            if(!input.value) return;

            // رسالة المستخدم
            const userDiv = document.createElement('div');
            userDiv.className = 'bubble user-bubble';
            userDiv.innerText = input.value;
            box.appendChild(userDiv);
            
            const userMsg = input.value;
            input.value = "";
            box.scrollTop = box.scrollHeight;

            // تفكير المساعد
            const aiDiv = document.createElement('div');
            aiDiv.className = 'bubble ai-bubble';
            aiDiv.innerText = "تِقني يفكر... ✨";
            box.appendChild(aiDiv);

            try {
                const response = await fetch('https://text.pollinations.ai/', {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({
                        messages: [
                            {role: 'system', content: 'أنت تِقني، مساعد مادة تقنية المعلومات بعمان. قدم إجابات تعليمية مشجعة ومبسطة جداً للطالب.'},
                            {role: 'user', content: userMsg + " \n علماً أن كودي هو: " + document.getElementById('editor').value}
                        ]
                    })
                });
                const data = await response.text();
                aiDiv.innerText = data;
            } catch {
                aiDiv.innerText = "عذراً يا بطل، لا يمكنني الاتصال بعقلي الآن. حاول مرة أخرى!";
            }
            box.scrollTop = box.scrollHeight;
        }

        function runPython() { window.pyRun(); }
        function clearAll() { if(confirm("مسح منطقة العمل؟")) document.getElementById('editor').value = ""; }
    </script>
</body>
</html>
