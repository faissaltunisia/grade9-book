<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>منصة تِقني الذكية | أ. فيصل العريبي</title>
    
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Tajawal:wght@400;700;900&display=swap" rel="stylesheet">
    
    <script src="https://cdnjs.cloudflare.com/ajax/libs/brython/3.11.0/brython.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/brython/3.11.0/brython_stdlib.min.js"></script>

    <style>
        :root {
            --bg-dark: #0f172a;
            --primary: #6366f1;
            --success: #10b981;
            --warning: #f59e0b;
            --glass: rgba(255, 255, 255, 0.07);
        }

        * { box-sizing: border-box; font-family: 'Tajawal', sans-serif; }
        body, html { margin: 0; padding: 0; height: 100%; width: 100vw; background: var(--bg-dark); color: white; overflow: hidden; display: flex; flex-direction: column; }

        header { height: 60px; padding: 0 20px; display: flex; justify-content: space-between; align-items: center; background: rgba(0,0,0,0.3); border-bottom: 1px solid var(--glass); }

        .workspace { flex: 1; display: flex; flex-direction: column; padding: 10px; position: relative; gap: 10px; }
        
        #editor { flex: 1.2; background: #0b1120; color: #38bdf8; padding: 15px; border-radius: 15px; border: 1px solid var(--glass); font-family: monospace; font-size: 1.1rem; outline: none; resize: none; }
        
        #console { flex: 0.8; background: #000; color: var(--success); padding: 15px; border-radius: 15px; border: 1px solid rgba(16, 185, 129, 0.2); overflow-y: auto; font-family: monospace; }

        /* --- بطاقة الإرشاد العائمة (المراقب الذكي) --- */
        #smart-guide-card {
            position: absolute;
            top: 20px;
            left: 20px;
            width: 250px;
            background: rgba(30, 41, 59, 0.95);
            backdrop-filter: blur(10px);
            border: 1px solid var(--primary);
            border-radius: 20px;
            padding: 15px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.5);
            z-index: 2000;
            display: none; /* تظهر عند الكتابة */
            animation: slideIn 0.5s ease-out;
        }

        .guide-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px; border-bottom: 1px solid var(--glass); padding-bottom: 5px; }
        #guide-msg { font-size: 0.85rem; color: #cbd5e1; line-height: 1.5; }

        /* أزرار التحكم السفلي */
        footer { height: 85px; background: #1e293b; display: flex; align-items: center; padding: 0 10px; gap: 10px; border-top: 1px solid var(--glass); }
        .btn { height: 55px; border-radius: 12px; border: none; color: white; font-weight: 900; font-size: 1rem; flex: 1; cursor: pointer; display: flex; align-items: center; justify-content: center; gap: 8px; }
        .btn-run { background: var(--success); flex: 2; }
        .btn-clear { background: #334155; color: #fca5a5; flex: 0.7; }

        @keyframes slideIn { from { opacity: 0; transform: translateX(-50px); } to { opacity: 1; transform: translateX(0); } }
    </style>
</head>
<body onload="brython()">

    <header>
        <div style="font-weight: 900; font-size: 1.2rem;">تِقني <span style="color:var(--primary)">LAB</span></div>
        <div style="font-size: 0.8rem; opacity: 0.7;">أ. فيصل العريبي</div>
    </header>

    <div class="workspace">
        <div id="smart-guide-card">
            <div class="guide-header">
                <span style="font-weight:bold; font-size:0.9rem; color:var(--success)"><i class="fas fa-robot"></i> تِقني يراقبك..</span>
                <i class="fas fa-times" onclick="closeGuide()" style="cursor:pointer; font-size:1rem;"></i>
            </div>
            <div id="guide-msg">ابدأ الكتابة وسأقوم بتحليل منطقك البرمجي هنا لتوجيهك.</div>
        </div>

        <textarea id="editor" oninput="handleTyping()" spellcheck="false" placeholder="ابدأ كتابة كود Python هنا..."></textarea>
        <div id="console">>>> المخرجات ستظهر هنا...</div>
    </div>

    <footer>
        <button class="btn btn-clear" onclick="clearAll()">مسح</button>
        <button class="btn btn-run" onclick="runCode()">تشغيل البرنامج</button>
    </footer>

    <script type="text/python">
        from browser import document, window
        def execute_py(ev=None):
            document["console"].text = ""
            def log(*args): document["console"].text += " ".join(map(str, args)) + "\n"
            try:
                exec(document["editor"].value, {"print": log, "input": window.prompt})
            except Exception as e:
                document["console"].text = f"خطأ برمي:\n{str(e)}"
        window.bryRun = execute_py
    </script>

    <script>
        let typingTimer;
        const guideCard = document.getElementById('smart-guide-card');
        const guideMsg = document.getElementById('guide-msg');

        function handleTyping() {
            // إظهار البطاقة عند أول كتابة
            if (guideCard.style.display !== 'block') {
                guideCard.style.display = 'block';
            }

            // تصفير المؤقت وبدء التحليل بعد توقف الطالب عن الكتابة بـ 2 ثانية
            clearTimeout(typingTimer);
            guideMsg.innerHTML = "<i class='fas fa-spinner fa-spin'></i> جاري تحليل كودك الآن...";
            
            typingTimer = setTimeout(performLiveAnalysis, 2000);
        }

        async function performLiveAnalysis() {
            const code = document.getElementById('editor').value;
            if (!code.trim()) return;

            try {
                const res = await fetch('https://text.pollinations.ai/', {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({
                        messages: [
                            {role: 'system', content: 'أنت تِقني، مساعد برمجي ذكي. حلل هذا الكود الصغير للطالب وقدم له توجيهاً قصيراً جداً (سطرين) لإصلاح خطأ أو تحسين كوده بأسلوب تعليمي.'},
                            {role: 'user', content: code}
                        ]
                    })
                });
                const data = await res.text();
                guideMsg.innerText = data;
            } catch {
                guideMsg.innerText = "واجهت مشكلة في الاتصال، لكن استمر في المحاولة!";
            }
        }

        function closeGuide() {
            guideCard.style.display = 'none';
        }

        function runCode() { window.bryRun(); }
        function clearAll() { 
            if(confirm("مسح الكود؟")) {
                document.getElementById('editor').value = "";
                closeGuide();
            }
        }
    </script>
</body>
</html>
